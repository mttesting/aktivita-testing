<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pracovn칤 캜asy</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f8f8f8;
    }
    h1 {
      margin-bottom: 10px;
    }
    h2 {
      margin-top: 40px;
    }
    .user {
      margin-bottom: 30px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .status-time {
      margin-left: 15px;
    }
  </style>
</head>
<body>
  <h1>Sou캜et pracovn칤ch stav콢 za rok <span id="year"></span></h1>
  <div id="output">Na캜칤t치n칤 dat...</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0klfrJWi5xNBF3EUkEmVVOE0F8CvjNRw",
      authDomain: "time-897fc.firebaseapp.com",
      projectId: "time-897fc",
      databaseURL: "https://time-897fc-default-rtdb.europe-west1.firebasedatabase.app",
      storageBucket: "time-897fc.appspot.com",
      messagingSenderId: "420987750968",
      appId: "1:420987750968:web:240c4462bad41137f6b4cd",
      measurementId: "G-W3WVS2FM3D"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentYear = new Date().getFullYear();
    document.getElementById("year").innerText = currentYear;

    function msToTime(duration) {
      const minutes = Math.floor((duration / (1000 * 60)) % 60);
      const hours = Math.floor(duration / (1000 * 60 * 60));
      return `${hours}h ${minutes}m`;
    }

    async function loadData() {
      const snapshot = await db.ref("statusHistory").once("value");
      const data = snapshot.val();
      const output = document.getElementById("output");
      output.innerHTML = "";

      if (!data) {
        output.innerText = "콯치dn치 data nebyla nalezena.";
        return;
      }

      Object.keys(data).forEach(user => {
        const userData = data[user];
        const statusTotals = {
          Active: 0,
          Break: 0,
          Inactive: 0
        };

        Object.keys(userData).forEach(date => {
          if (!date.startsWith(currentYear.toString())) return;

          const dayData = userData[date];
          for (let i = 0; i < dayData.length - 1; i++) {
            const current = dayData[i];
            const next = dayData[i + 1];
            const duration = next.timestamp - current.timestamp;
            if (statusTotals[current.status] !== undefined) {
              statusTotals[current.status] += duration;
            }
          }

          // Pokud posledn칤 status pokra캜uje do p콢lnoci
          const last = dayData[dayData.length - 1];
          const midnight = new Date(date + "T23:59:59").getTime();
          if (last && statusTotals[last.status] !== undefined && last.timestamp < midnight) {
            statusTotals[last.status] += midnight - last.timestamp;
          }
        });

        // Vykreslen칤
        const div = document.createElement("div");
        div.className = "user";
        div.innerHTML = `<h2>${user}</h2>
          <div class="status-time">游릭 Active: ${msToTime(statusTotals.Active)}</div>
          <div class="status-time">游 Break: ${msToTime(statusTotals.Break)}</div>
          <div class="status-time">游댮 Inactive: ${msToTime(statusTotals.Inactive)}</div>`;
        output.appendChild(div);
      });
    }

    loadData();
  </script>
</body>
</html>